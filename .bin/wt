#!/bin/bash
set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Run the TypeScript CLI, streaming output and capturing exec JSON
# Use a pipe with PIPESTATUS to preserve the exit code
exec_json=""
bun "$ROOT_DIR/packages/dev-tools/src/wt-cli.ts" "$@" 2>&1 | while IFS= read -r line; do
    if printf '%s' "$line" | jq -e '.exec' > /dev/null 2>&1; then
        # Write exec JSON to a temp file so we can access it after the loop
        printf '%s' "$line" > /tmp/wt-exec-$$
    else
        printf '%s\n' "$line"
    fi
done
cli_exit=${PIPESTATUS[0]}

if [ $cli_exit -ne 0 ]; then
    rm -f /tmp/wt-exec-$$
    exit $cli_exit
fi

# Check if we have an exec command
if [ -f /tmp/wt-exec-$$ ]; then
    exec_json=$(cat /tmp/wt-exec-$$)
    rm -f /tmp/wt-exec-$$
    
    cwd=$(printf '%s' "$exec_json" | jq -r '.exec.cwd')
    cmd=$(printf '%s' "$exec_json" | jq -r '.exec.cmd // empty')
    prompt=$(printf '%s' "$exec_json" | jq -r '.exec.prompt // empty')
    
    cd "$cwd"
    
    if [ -n "$cmd" ]; then
        if [ "$cmd" = "opencode" ]; then
            exec opencode
        elif [ "$cmd" = "code" ]; then
            if [ -z "$VISUAL" ]; then
                echo "Warning: \$VISUAL not set. Add to your shell profile:"
                echo "  export VISUAL=\"code-insiders\"  # or your preferred editor"
                echo "Falling back to VS Code..."
                exec open -a "Visual Studio Code" "$cwd"
            else
                exec "$VISUAL" "$cwd"
            fi
        else
            exec "$cmd" "$cwd"
        fi
    elif [ -n "$prompt" ]; then
        exec opencode --prompt="$prompt"
    else
        echo "Error: Invalid exec format"
        exit 1
    fi
fi
